#!/bin/bash
user=`env | grep USER=root`
if [[ $user == "USER=root" ]];then
  kubectl apply -f ./config/cve_2018_1002105_namespace.yaml
  kubectl apply -f ./config/cve_2018_1002105_role.yaml
  kubectl apply -f ./config/cve_2018_1002105_role_binding.yaml
  kubectl apply -f ./config/cve_2018_1002105_pod.yaml
  cp ./config/test-token.csv /etc/kubernetes/pki/test-token.csv
  if [[ `sudo grep test-token.csv /etc/kubernetes/manifests/kube-apiserver.yaml` ]];then
    echo "The token file has been added."
  else
    sed -i '/\/etc\/kubernetes\/pki\/apiserver.key/a\    - --token-auth-file=\/etc\/kubernetes\/pki\/test-token.csv' /etc/kubernetes/manifests/kube-apiserver.yaml
    echo "Configuration finished."
  fi

else
  sudo kubectl apply -f ./config/cve_2018_1002105_namespace.yaml
  sudo kubectl apply -f ./config/cve_2018_1002105_role.yaml
  sudo kubectl apply -f ./config/cve_2018_1002105_role_binding.yaml
  sudo kubectl apply -f ./config/cve_2018_1002105_pod.yaml
  sudo cp ./config/test-token.csv /etc/kubernetes/pki/test-token.csv
  if [[ `sudo grep test-token.csv /etc/kubernetes/manifests/kube-apiserver.yaml` ]];then
    echo "The token file has been added."
  else
    sudo sed -i '/\/etc\/kubernetes\/pki\/apiserver.key/a\    - --token-auth-file=\/etc\/kubernetes\/pki\/test-token.csv' /etc/kubernetes/manifests/kube-apiserver.yaml
    echo "Configuration finished."
  fi
fi
