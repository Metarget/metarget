#!/bin/bash
user=`env | grep USER=root`
if [[ $user == "USER=root" ]];then
  kubectl apply -f ./config/cve_2017_1002101_policy.yaml
  kubectl apply -f ./config/cve_2017_1002101_role_binding.yaml
  kubectl apply -f ./config/cve_2017_1002101_role.yaml
  if [[ `sudo grep PodSecurityPolicy /etc/kubernetes/manifests/kube-apiserver.yaml` ]];then
    echo "The policy has been added."
  else
    sed -i 's/\-\-admission\-control\=/\-\-admission\-control\=PodSecurityPolicy\,/g' /etc/kubernetes/manifests/kube-apiserver.yaml
    echo "Configuration finished."
  fi

else
  sudo kubectl apply -f ./config/cve_2017_1002101_policy.yaml
  sudo kubectl apply -f ./config/cve_2017_1002101_role_binding.yaml
  sudo kubectl apply -f ./config/cve_2017_1002101_role.yaml
  if [[ `sudo grep PodSecurityPolicy /etc/kubernetes/manifests/kube-apiserver.yaml` ]];then
    echo "The policy has been added."
  else
    sudo sed -i 's/\-\-admission\-control\=/\-\-admission\-control\=PodSecurityPolicy\,/g' /etc/kubernetes/manifests/kube-apiserver.yaml
    echo "Configuration finished."
  fi
fi
